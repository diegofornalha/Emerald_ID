{"version":3,"file":"actor.module.js","sources":["../src/mailbox/index.js","../src/index.js"],"sourcesContent":["export const mailbox = () => {\n  const queue = []\n  var next\n\n  return {\n    async deliver(msg) {\n      queue.push(msg)\n      if (next) {\n        next(queue.shift())\n        next = undefined\n      }\n    },\n\n    receive() {\n      return new Promise(function innerReceive(resolve) {\n        const msg = queue.shift()\n        if (msg) return resolve(msg)\n        next = resolve\n      })\n    },\n  }\n}\n","import {mailbox as createMailbox} from \"./mailbox\"\nimport queueMicrotask from \"queue-microtask\"\n\nexport const INIT = \"INIT\"\nexport const SUBSCRIBE = \"SUBSCRIBE\"\nexport const UNSUBSCRIBE = \"UNSUBSCRIBE\"\nexport const UPDATED = \"UPDATED\"\nexport const SNAPSHOT = \"SNAPSHOT\"\nexport const EXIT = \"EXIT\"\nexport const TERMINATE = \"TERMINATE\"\n\nconst root =\n  (typeof self === \"object\" && self.self === self && self) ||\n  (typeof global === \"object\" && global.global === global && global) ||\n  (typeof window === \"object\" && window.window === window && window)\n\nroot.FCL_REGISTRY = root.FCL_REGISTRY == null ? {} : root.FCL_REGISTRY\nvar pid = 0b0\n\nconst DEFAULT_TIMEOUT = 5000\nconst DEFAULT_TAG = \"---\"\nexport const send = (addr, tag, data, opts = {}) =>\n  new Promise((reply, reject) => {\n    const expectReply = opts.expectReply || false\n    const timeout = opts.timeout != null ? opts.timeout : DEFAULT_TIMEOUT\n\n    if (expectReply && timeout) {\n      setTimeout(\n        () =>\n          reject(new Error(`Timeout: ${timeout}ms passed without a response.`)),\n        timeout\n      )\n    }\n\n    const payload = {\n      to: addr,\n      from: opts.from,\n      tag,\n      data,\n      timeout,\n      reply,\n      reject,\n    }\n\n    try {\n      root.FCL_REGISTRY[addr] &&\n        root.FCL_REGISTRY[addr].mailbox.deliver(payload)\n      if (!expectReply) reply(true)\n    } catch (error) {\n      console.error(\n        \"FCL.Actor -- Could Not Deliver Message\",\n        payload,\n        root.FCL_REGISTRY[addr],\n        error\n      )\n    }\n  })\n\nexport const kill = addr => {\n  delete root.FCL_REGISTRY[addr]\n}\n\nconst fromHandlers = (handlers = {}) => async ctx => {\n  if (typeof handlers[INIT] === \"function\") await handlers[INIT](ctx)\n  __loop: while (1) {\n    const letter = await ctx.receive()\n    try {\n      if (letter.tag === EXIT) {\n        if (typeof handlers[TERMINATE] === \"function\") {\n          await handlers[TERMINATE](ctx, letter, letter.data || {})\n        }\n        break __loop\n      }\n      await handlers[letter.tag](ctx, letter, letter.data || {})\n    } catch (error) {\n      console.error(`${ctx.self()} Error`, letter, error)\n    } finally {\n      continue __loop\n    }\n  }\n}\n\nexport const spawn = (fn, addr = null) => {\n  if (addr == null) addr = ++pid\n  if (root.FCL_REGISTRY[addr] != null) return addr\n\n  root.FCL_REGISTRY[addr] = {\n    addr,\n    mailbox: createMailbox(),\n    subs: new Set(),\n    kvs: {},\n  }\n\n  const ctx = {\n    self: () => addr,\n    receive: () => root.FCL_REGISTRY[addr].mailbox.receive(),\n    send: (to, tag, data, opts = {}) => {\n      opts.from = addr\n      return send(to, tag, data, opts)\n    },\n    sendSelf: (tag, data, opts) => {\n      if (root.FCL_REGISTRY[addr]) send(addr, tag, data, opts)\n    },\n    broadcast: (tag, data, opts = {}) => {\n      opts.from = addr\n      for (let to of root.FCL_REGISTRY[addr].subs) send(to, tag, data, opts)\n    },\n    subscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.add(sub),\n    unsubscribe: sub => sub != null && root.FCL_REGISTRY[addr].subs.delete(sub),\n    subscriberCount: () => root.FCL_REGISTRY[addr].subs.size,\n    hasSubs: () => !!root.FCL_REGISTRY[addr].subs.size,\n    put: (key, value) => {\n      if (key != null) root.FCL_REGISTRY[addr].kvs[key] = value\n    },\n    get: (key, fallback) => {\n      const value = root.FCL_REGISTRY[addr].kvs[key]\n      return value == null ? fallback : value\n    },\n    delete: key => {\n      delete root.FCL_REGISTRY[addr].kvs[key]\n    },\n    update: (key, fn) => {\n      if (key != null)\n        root.FCL_REGISTRY[addr].kvs[key] = fn(root.FCL_REGISTRY[addr].kvs[key])\n    },\n    keys: () => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs)\n    },\n    all: () => {\n      return root.FCL_REGISTRY[addr].kvs\n    },\n    where: pattern => {\n      return Object.keys(root.FCL_REGISTRY[addr].kvs).reduce((acc, key) => {\n        return pattern.test(key)\n          ? {...acc, [key]: root.FCL_REGISTRY[addr].kvs[key]}\n          : acc\n      }, {})\n    },\n    merge: (data = {}) => {\n      Object.keys(data).forEach(\n        key => (root.FCL_REGISTRY[addr].kvs[key] = data[key])\n      )\n    },\n  }\n\n  if (typeof fn === \"object\") fn = fromHandlers(fn)\n\n  queueMicrotask(async () => {\n    await fn(ctx)\n    kill(addr)\n  })\n\n  return addr\n}\n\n// Returns an unsubscribe function\n// A SUBSCRIBE handler will need to be created to handle the subscription event\n//\n//  [SUBSCRIBE]: (ctx, letter) => {\n//    ctx.subscribe(letter.from)\n//    ctx.send(letter.from, UPDATED, ctx.all())\n//  }\n//\nexport function subscriber(address, spawnFn, callback) {\n  spawnFn(address)\n  const EXIT = \"@EXIT\"\n  const self = spawn(async ctx => {\n    ctx.send(address, SUBSCRIBE)\n    while (1) {\n      const letter = await ctx.receive()\n      if (letter.tag === EXIT) {\n        ctx.send(address, UNSUBSCRIBE)\n        return\n      }\n      callback(letter.data)\n    }\n  })\n  return () => send(self, EXIT)\n}\n\n// Returns a promise that returns a result\n// A SNAPSHOT handler will need to be created to handle the snapshot event\n//\n//  [SNAPSHOT]: (ctx, letter) => {\n//    letter.reply(ctx.all())\n//  }\n//\nexport function snapshoter(address, spawnFn) {\n  spawnFn(address)\n  return send(address, SNAPSHOT, null, {expectReply: true, timeout: 0})\n}\n"],"names":["mailbox","queue","next","deliver","msg","push","shift","undefined","receive","Promise","innerReceive","resolve","body","recover","result","e","then","finalizer","bind","pact","state","value","s","v","o","observer","prototype","onFulfilled","onRejected","callback","_this","thenable","test","update","stage","shouldContinue","updateValue","reject","_resumeAfterTest","_resumeAfterBody","_resumeAfterUpdate","INIT","SUBSCRIBE","UNSUBSCRIBE","UPDATED","SNAPSHOT","EXIT","TERMINATE","root","self","global","window","FCL_REGISTRY","pid","DEFAULT_TIMEOUT","send","addr","tag","data","opts","reply","expectReply","timeout","setTimeout","Error","payload","to","from","error","console","kill","fromHandlers","handlers","ctx","letter","spawn","fn","createMailbox","subs","Set","kvs","sendSelf","broadcast","subscribe","sub","add","unsubscribe","subscriberCount","size","hasSubs","put","key","get","fallback","keys","Object","all","where","pattern","reduce","acc","merge","forEach","queueMicrotask","subscriber","address","spawnFn","snapshoter"],"mappings":"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"}